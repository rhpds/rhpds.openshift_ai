apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: model-as-a-service
  namespace: openshift-gitops
spec:
  destination:
    namespace: maas-api
    server: 'https://kubernetes.default.svc'
  ignoreDifferences:
    - group: '*'
      jqPathExpressions:
        - '.imagePullSecrets[] | select(.name | contains("-dockercfg-"))'
      kind: ServiceAccount
  project: default
  source:
    helm:
      valuesObject:
        clusterDomain: {{ openshift_cluster_ingress_domain }}
        apiUsers:
{% for i in range(1, (ocp4_workload_openshift_ai_model_as_a_service_api_users.tierFreeUsers.count | default(0) | int) + 1) %}
        - username: {{ ocp4_workload_openshift_ai_model_as_a_service_api_users.tierFreeUsers.usernamePrefix }}{{ i | string }}
          apiKey: {{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits') }}
          tier: tier-free-users
{% endfor %}
{% for i in range(1, (ocp4_workload_openshift_ai_model_as_a_service_api_users.tierPremiumUsers.count | default(0) | int) + 1) %}
        - username: {{ ocp4_workload_openshift_ai_model_as_a_service_api_users.tierPremiumUsers.usernamePrefix }}{{ ( i | string ) if ocp4_workload_openshift_ai_model_as_a_service_api_users.tierPremiumUsers.count > 1 else '' }}
          apiKey: {{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits') }}
          tier: tier-premium-users
{% endfor %}
{% for i in range(1, (ocp4_workload_openshift_ai_model_as_a_service_api_users.tierEnterpriseUsers.count | default(0) | int) + 1) %}
        - username: {{ ocp4_workload_openshift_ai_model_as_a_service_api_users.tierEnterpriseUsers.usernamePrefix }}{{ ( i | string ) if ocp4_workload_openshift_ai_model_as_a_service_api_users.tierEnterpriseUsers.count > 1 else '' }}
          apiKey: {{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits') }}
          tier: tier-enterprise-users
{% endfor %}
        llmInferenceServices:
        {{ ocp4_workload_openshift_ai_model_as_a_service_models | to_yaml | indent(8) }}
        image:
          repository: {{ ocp4_workload_openshift_ai_model_as_a_service_api_image_repository }}
          tag: {{ ocp4_workload_openshift_ai_model_as_a_service_api_image_repository_tag }}
    repoURL: {{ ocp4_workload_openshift_ai_model_as_a_service_helm_repo }}
    targetRevision: {{ ocp4_workload_openshift_ai_model_as_a_service_helm_repo_target_revision }}
    path: ./
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 2m
      limit: -1
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true